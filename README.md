
# Custom Auth & Authorization Backend

## Описание

Это backend-приложение с собственной системой аутентификации и авторизации, реализованной без использования стандартных средств Django Auth.  
Основная задача — управление доступом пользователей к ресурсам на основе ролей и разрешений.

---

## Технологии

- Python 3.x
- Django 4.x
- Django REST Framework
- PostgreSQL (рекомендуется)
- JWT для аутентификации

---

## Структура базы данных

### Модель User

- `email` — уникальный email пользователя, используется для логина
- `password_hash` — хэш пароля
- `first_name`, `last_name`, `patronymic` — ФИО
- `is_active` — флаг активности (мягкое удаление)
- `is_staff`, `is_superuser` — права администратора

### Модель Role

- `name` — название роли (например, Admin, Manager, User)

### Модель Permission

- `action` — действие (read, write, delete)
- `resource` — ресурс (например, `/documents/`)

### Связующие таблицы

- UserRole: связывает пользователей с ролями
- RolePermission: связывает роли с разрешениями

---

## Принцип работы системы прав доступа

1. Пользователь при логине получает JWT-токен.
2. При обращении к защищенным ресурсам сервер извлекает пользователя из токена.
3. Проверяется, какие роли у пользователя.
4. Для каждой роли смотрятся разрешения (action + resource).
5. Если разрешение найдено — доступ разрешён.
6. Иначе — возвращается ошибка 403 Forbidden.
7. Если пользователь не залогинен — ошибка 401 Unauthorized.

---

## API Endpoints

| Метод | URL                   | Описание                     | Доступ                        |
|-------|-----------------------|------------------------------|------------------------------|
| POST  | `/register/`          | Регистрация пользователя     | Public                       |
| POST  | `/login/`             | Логин, получение JWT         | Public                       |
| POST  | `/logout/`            | Выход                        | Авторизованные пользователи  |
| GET   | `/protected/`         | Тестовый защищенный эндпоинт | Авторизованные пользователи  |
| GET   | `/documents/`         | Просмотр документов          | По правам (read)             |
| POST  | `/documents/create/`  | Создание документа           | По правам (write)            |
| DELETE| `/documents/delete/`  | Удаление документа           | По правам (delete)           |

---

## Запуск и тестирование

1. Клонируйте репозиторий и установите зависимости:
   ```
   pip install -r requirements.txt
   ```
2. Настройте базу данных PostgreSQL и проект (.env.sample файл).
3. Выполните миграции:
   ```
   python manage.py migrate
   ```
4. Запустите сервер:
   ```
   python manage.py runserver
   ```
5. Заполните тестовые данные:
   ```
   python manage.py load_initial_data
   ```
6. Тестируйте API через Postman.

---

## Пример использования в Postman

- Авторизация:
  - POST `/login/`
  - Body JSON: `{"email": "admin@example.com", "password": "adminpass"}`
  - В ответ получите `token`.

- Использование токена:
  - Добавьте в Header:
    ```
    Authorization: Bearer <token>
    ```
  - Вызовите защищённые эндпоинты.

---

## Особенности реализации

- Пользователи с `is_active=False` не могут войти.
- Пароли хранятся в хэшированном виде.
- Мягкое удаление пользователей (статус активности).
- Проверка прав доступа на уровне представлений.
- Полностью кастомная модель пользователя.

---
